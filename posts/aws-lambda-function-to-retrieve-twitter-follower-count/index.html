<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=author content="Miro Sopanen ">
<meta name=description content>
<meta name=keywords content=",AWS,Python">
<meta name=robots content="noodp">
<meta name=theme-color content="#d58432">
<link rel=canonical href=https://sopanen.net/posts/aws-lambda-function-to-retrieve-twitter-follower-count/>
<title>
AWS Lambda function to retrieve Twitter follower count
</title>
<link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css>
<link rel=stylesheet href=https://sopanen.net/main.491d9de14a60a99da243398aa5873cb28a058c58cb30eb698c56e003d11d6aab.css>
<meta itemprop=name content="AWS Lambda function to retrieve Twitter follower count">
<meta itemprop=description content="Intro üëá One of my goals for this current year is to get more comfortable with AWS and get certified eventually. Therefore I will be trying out different things and blogging about it here.
I am starting out with a quite simple task and that is deploying an AWS Lambda function. In this case an AWS Lambda function that retrieves the count of your current Twitter followers.
Everytime the AWS API endpoint gets called, a Python script will run that will retrieve the current stats from the Twitter API and then returns it in JSON format so it can be easily used across systems."><meta itemprop=datePublished content="2020-08-29T09:28:55+02:00">
<meta itemprop=dateModified content="2020-08-29T09:28:55+02:00">
<meta itemprop=wordCount content="1788"><meta itemprop=image content="https://sopanen.net">
<meta itemprop=keywords content="AWS,Python,">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://sopanen.net">
<meta name=twitter:title content="AWS Lambda function to retrieve Twitter follower count">
<meta name=twitter:description content="Intro üëá One of my goals for this current year is to get more comfortable with AWS and get certified eventually. Therefore I will be trying out different things and blogging about it here.
I am starting out with a quite simple task and that is deploying an AWS Lambda function. In this case an AWS Lambda function that retrieves the count of your current Twitter followers.
Everytime the AWS API endpoint gets called, a Python script will run that will retrieve the current stats from the Twitter API and then returns it in JSON format so it can be easily used across systems.">
<meta property="article:published_time" content="2020-08-29 09:28:55 +0200 +0200">
</head>
<body class=dark-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=https://sopanen.net/ style=text-decoration:none>
<div class=logo>
<span class=logo__mark>></span>
<span class=logo__text>$ cd /home/</span>
<span class=logo__cursor>
</span>
</div>
</a>
<span class=header__right>
<nav class=menu>
<ul class=menu__inner><li><a href=https://sopanen.net/about/>About</a></li><li><a href=https://sopanen.net/posts/>Posts</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<main class=post>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
9 minutes
</p>
</div>
<article>
<h1 class=post-title>
<a href=https://sopanen.net/posts/aws-lambda-function-to-retrieve-twitter-follower-count/>AWS Lambda function to retrieve Twitter follower count</a>
</h1>
<div class=post-content>
<h2 id=intro->Intro üëá</h2>
<p>One of my goals for this current year is to get more comfortable with AWS and get certified eventually. Therefore I will be trying out different things and blogging about it here.</p>
<p>I am starting out with a quite simple task and that is deploying an <strong>AWS Lambda function</strong>. In this case an AWS Lambda function that retrieves the count of your current Twitter followers.</p>
<p>Everytime the AWS API endpoint gets called, a Python script will run that will retrieve the current stats from the Twitter API and then returns it in JSON format so it can be easily used across systems.</p>
<p><strong>Disclaimer:</strong> I am not an expert in AWS. So I might not use best practices everywhere.</p>
<h2 id=what-is-an-aws-lambda-function->What is an AWS Lambda function? üî∂</h2>
<p>From the docs:</p>
<blockquote>
<p>AWS Lambda is a serverless compute service that runs your code in response to events and automatically manages the underlying compute resources for you.</p>
</blockquote>
<p>The code you run on AWS Lambda is called a &ldquo;Lambda function&rdquo;. Lambda <strong>runs your code on high-availability compute infrastructure</strong> and performs all the administration of the compute resources. So for example server and operating system maintenance, capacity provisioning and automatic scaling, code and security patch deployment, and code monitoring and logging.</p>
<p>When you create and deploy your Lambda function, it is always ready to run as soon as you trigger it. These triggers you set-up yourself. Some examples that you can use to trigger your Lambda function:</p>
<ul>
<li>HTTP requests via the Amazon API Gateway</li>
<li>Modifications to objects in Amazon S3</li>
<li>Table updates in Amazon DynamoDB</li>
<li>State transitions in AWS Step Functions</li>
</ul>
<p>In this post we will use the first one, a HTTP request via the Amazon API Gateway.</p>
<h2 id=setting-up-the-base-for-the-function->Setting up the base for the function üÜí</h2>
<p>In order to set-up the Lambda function you need to create an AWS account. Login using your existing account or sign up for a new account using <a href=https://console.aws.amazon.com/>this link</a>.</p>
<p>After the initial set-up of your account, follow the menu link <em><strong>Services</strong></em>, then under the heading <em><strong>Compute</strong></em> click on the link <em><strong>Lambda</strong></em>.</p>
<p>On the left side you are greeted with a small menu, go to <em><strong>Functions</strong></em>. Here we will create the base of the function and give it a name. Later on we are deploying our actual Python code from the command line using the AWS CLI tool.</p>
<p><img src=https://sopanen.net/images/blog/1/image1.png alt="create AWS Lambda function"></p>
<p>Name the function <code>getTwitterFollowerCount</code> and at runtime choose Python 3.8, since we are using Python code later on. AWS Lambda has all the major languages available, so you can easily pick another one in a later stage if you would prefer that.</p>
<p>At the permission section make sure you pick the first option: &ldquo;Create a new role with basic Lambda permissions&rdquo;. Now finalize it and create the actual function by going to the top-right side of the page and click <em><strong>Create Function</strong></em>.</p>
<p>Congrats you have made your first AWS Lambda Function! üèÜ</p>
<h2 id=testing-our-new-function->Testing our new function ‚úÖ</h2>
<p>Alrighty, time to test our new function. If everything went correct you will be greeted with a configuration panel of the function you have just made, similar to the one below.</p>
<p><img src=https://sopanen.net/images/blog/1/image2.png alt="controlpanel AWS Lambda function"></p>
<p>As you can see in the function code, every function that gets created comes with some boilerplate code that includes a Lambda handler. The Lambda handler is the function in your code, that AWS Lambda can invoke when the service executes your code. For Python the general syntax structure looks like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handler_name</span>(event, context): 
    <span style=color:#f92672>...</span>
    <span style=color:#66d9ef>return</span> some_value
</code></pre></div><p>You always need to specify a handler, otherwise your function won&rsquo;t run and the deploy build will fail.</p>
<p>As you can see at the function code in the AWS console, the default Lambda handler that got generated when we created the function looks like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>lambda_handler</span>(event, context):
    <span style=color:#66d9ef>return</span> {
        <span style=color:#e6db74>&#39;statusCode&#39;</span>: <span style=color:#ae81ff>200</span>,
        <span style=color:#e6db74>&#39;body&#39;</span>: json<span style=color:#f92672>.</span>dumps(<span style=color:#e6db74>&#39;Hello from Lambda!&#39;</span>)
    }
</code></pre></div><p>Let&rsquo;s see what is going on here. Whenever the Lambda function gets executed, it will run this Python function and then return a <code>statuscode 200</code> and a JSON response saying <code>Hello from Lambda!</code></p>
<p>Time to test this!</p>
<p>Click the <em><strong>Test</strong></em> button at the right top of the function configuration panel. You will see a pop-up like the one below. We can use all the default settings here for this small test. The only thing we need to do is entering <code>testEvent</code> at the &ldquo;Event name&rdquo; field. Once done, click <em><strong>Create</strong></em> at the bottom right.</p>
<p><img src=https://sopanen.net/images/blog/1/image3.png alt="test event for AWS Lambda function"></p>
<p>All done. Now all that is left is the actual test of the function. Click the <em><strong>Test</strong></em> button again and look at the output below. As you can see we ran our function and got our JSON response back, neat! üî•</p>
<p>There is some additional information that is available to us that you can find back in the logs each time you execute a Lambda function. This is for example: the request ID, the time it took to execute the function, the memory usage etc.</p>
<p><img src=https://sopanen.net/images/blog/1/image4.png alt="test log AWS Lambda function"></p>
<p>So we created the Lambda function, tested it, now it is time to write our actual Python function that contains the logic for retrieving data from the Twitter API regarding our current follower count.</p>
<h2 id=writing-our-python-code->Writing our Python code üêç</h2>
<p>Alright the first thing we do is creating a virtual environment for Python, so that all our packages are contained within this envirnoment and not installed globally. Make sure you have installed <code>virtualenv</code> and <code>pip</code>. There are a lot of resources available on the internet for this, I won&rsquo;t get into that here since it is out of the scope of this blogpost.</p>
<p>So let&rsquo;s create our environment through the command line:</p>
<pre tabindex=0><code>$ virtualenv -p python3.8 lambda
</code></pre><p>You might have different Python versions running on your machine, therefore we specify the Python version explicitly when creating the virtual environment, so it matches with our Python version of our Lambda function. After creating the env, activate it and <code>cd</code> into it.</p>
<pre tabindex=0><code>$ source lambda/bin/activate &amp;&amp; cd lambda
</code></pre><p>Now create a <code>src</code> folder within the lambda folder, where we will store our Python code and <code>cd</code> into it.</p>
<pre tabindex=0><code>$ mkdir src &amp;&amp; cd src
</code></pre><p>To retrieve the actual follower count data we will be using a Python package which acts as a Python wrapper around the Twitter API. You can install it using:</p>
<pre tabindex=0><code>$ pip install python-twitter
</code></pre><p>Now create a new Python file and start-up VS code (or whatever you prefer):</p>
<pre tabindex=0><code>$ code lambda_function.py
</code></pre><p>To access the Twitter API you will need an developer account in order to get API credentials. Head over to <a href=https://developer.twitter.com>developer.twitter.com</a> and create one. Now use the following code snippet in your Python file:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> twitter

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>lambda_handler</span>(event, context):
    CONSUMER_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;PMRxxgv52052lskdtgsd&#39;</span>
    CONSUMER_SECRET <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;RwiDbasg234lsdSADF235dkAJKIlcGCIcSI&#39;</span>
    ACCESS_TOKEN <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;1074466481134323569-ciuXuhDGOIYHfnssaEFCXugPsN&#39;</span>
    ACCESS_TOKEN_SECRET <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;yAIASSldf43efdSXGsj888fghjdffgK68dd&#39;</span>
    SCREEN_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;rafrasenberg&#39;</span>

    <span style=color:#75715e># Create an Api instance.</span>
    api <span style=color:#f92672>=</span> twitter<span style=color:#f92672>.</span>Api(consumer_key<span style=color:#f92672>=</span>CONSUMER_KEY,
                    consumer_secret<span style=color:#f92672>=</span>CONSUMER_SECRET,
                    access_token_key<span style=color:#f92672>=</span>ACCESS_TOKEN,
                    access_token_secret<span style=color:#f92672>=</span>ACCESS_TOKEN_SECRET)

    data <span style=color:#f92672>=</span> api<span style=color:#f92672>.</span>GetUser(screen_name<span style=color:#f92672>=</span>SCREEN_NAME)


    <span style=color:#66d9ef>return</span> { 
        <span style=color:#e6db74>&#39;followers&#39;</span> : data<span style=color:#f92672>.</span>followers_count
    }
</code></pre></div><p>Make sure to replace the variables with your credentials (I used fake credentials in this post, obviously) and Twitter handle. The Python code is quite simple, let me explain shortly what is going on here:</p>
<ol>
<li>We create an API instance with the credentials</li>
<li>We use the <code>GetUser</code> API endpoint to get data based on the Twitter handle</li>
<li>From the JSON response that we get from Twitter, we get the amount of followers of a user with <code>data.followers_count</code></li>
<li>We wrap this API call in a <code>lambda_handler</code> and return our own JSON response</li>
</ol>
<p>So the Python code is working, now back to our Lambda function!</p>
<h2 id=aws-lambda-deployment-package-through-aws-cli->AWS Lambda deployment package through AWS CLI üîÅ</h2>
<p>Make sure you have AWS CLI set-up on your machine to continue with this part. <a href=https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html>Check out the docs</a> to see how to install it on different operating systems, I won&rsquo;t be going over that here.</p>
<p>Because we have external dependencies in our Python code (The Twitter API wrapper), we need to turn it into a deployment package. This is required anytime you are using the Lambda API to manage functions, or if you need to include libraries and dependencies other than the AWS SDK. A deployment package is a ZIP archive that contains your function code and dependencies.</p>
<p>So what we want to do first is zip all the site-packages of our Python code. First check your folder structure, on my machine the base folder (the virtual environment with the src files) is located in <code>~/Development/lambda</code>. When running the command below, replace all the <code>~/Development/lambda</code> parts, with the correct path of your own machine.</p>
<pre tabindex=0><code>$ cd ~/Development/lambda/lib/python3.8/site-packages &amp;&amp; zip -r9 ~/Development/lambda/src/function.zip . &amp;&amp; cd ~/Development/lambda/src
</code></pre><p>If everything went well, you have a freshly generated <code>function.zip</code> file now in the <code>src</code> folder. üòÑ All that is left right now is adding the function code to our archive, by running the command below.</p>
<pre tabindex=0><code>$ zip -g functions.zip lambda_function.py
</code></pre><p>Great! üèÜ Now we have a binary ZIP package that is ready to be deployed to Lambda. What we will do is run an update command. We will use the Lambda function that we created earlier through the AWS console and update that. We use the AWS CLI command <code>aws lambda update-function-code</code> for that. We add two arguments, the name of the function, which is <code>getTwitterFollowerCount</code> and the location of the ZIP deployment package.</p>
<p><strong>Note:</strong> If you named your Lambda function differently in the AWS Console earlier, make sure you change this command as well to match the correct name.</p>
<pre tabindex=0><code>$ aws lambda update-function-code --function-name getTwitterFollowerCount --zip-file fileb://function.zip
</code></pre><p>After running the above command you will receive a JSON response similar to the one below.</p>
<pre tabindex=0><code>{
    &quot;FunctionName&quot;: &quot;getTwitterFollowerCount&quot;,
    &quot;FunctionArn&quot;: &quot;arn:aws:lambda:eu-central-1:001533050737:function:getTwitterFollowerCount&quot;,
    &quot;Runtime&quot;: &quot;python3.8&quot;,
    &quot;Role&quot;: &quot;arn:aws:iam::001533050737:role/service-role/getTwitterFollowerCount-role-m8vxr9y6&quot;,
    &quot;Handler&quot;: &quot;lambda_function.lambda_handler&quot;,
    &quot;CodeSize&quot;: 4996597,
    &quot;Description&quot;: &quot;&quot;,
    &quot;Timeout&quot;: 3,
    &quot;MemorySize&quot;: 128,
    &quot;LastModified&quot;: &quot;2020-08-29T11:47:52.701+0000&quot;,
    &quot;CodeSha256&quot;: &quot;0HPUHFxNWqu6xLl2NistRBoHp6FEBvnBFXnRXjfomXA=&quot;,
    &quot;Version&quot;: &quot;$LATEST&quot;,
    &quot;TracingConfig&quot;: {
        &quot;Mode&quot;: &quot;PassThrough&quot;
    },
    &quot;RevisionId&quot;: &quot;6c16c627-d4e2-4057-b38d-94cb16395f2f&quot;,
    &quot;State&quot;: &quot;Active&quot;,
    &quot;LastUpdateStatus&quot;: &quot;Successful&quot;
}
</code></pre><h2 id=setting-up-the-api-gateway>Setting up the API Gateway</h2>
<p>The final step we have to take is setting up an API endpoint, so we can actually call our function through a HTTP call. Go back to the AWS console and the function configuration panel. Click the <em><strong>Add trigger</strong></em> button.</p>
<p><img src=https://sopanen.net/images/blog/1/image5.png alt="test log AWS Lambda function"></p>
<p>In the following screen use the settings below and click the button <em><strong>Add</strong></em>.</p>
<p><img src=https://sopanen.net/images/blog/1/image6.png alt="test log AWS Lambda function"></p>
<blockquote>
<h3 id=done->DONE! üî•üèÜ</h3>
</blockquote>
<p>All that is left now is checking what our actual HTTP endpoint is and test it, to see if everything works as it should. Check out the API Gateway at the bottom of the dashboard and expand it by pressing <em><strong>Details</strong></em>. As you can see we can find the API endpoint there.</p>
<p><img src=https://sopanen.net/images/blog/1/image7.png alt="test log AWS Lambda function"></p>
<p>Fire up the command line and use something like <code>curl</code> to test for the response.</p>
<pre tabindex=0><code>$ curl 'https://4k1g4gaqz2.execute-api.eu-central-1.amazonaws.com/default/getTwitterFollowerCount'
</code></pre><p>If everything went well, you just received a nice JSON response with your current follower count!</p>
<pre tabindex=0><code>$ {
  &quot;followers&quot;: 18311
}
</code></pre><p>Easy peasy, lemon squeezy. You now have a serverless AWS Lambda function running that you can call from anywhere you want without the need of any server. Awesome.</p>
<p>See you next time. üëã</p>
</div>
</article>
<hr>
<div class=post-info>
<p>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://sopanen.net/tags/aws/>AWS</a></span><span class=tag><a href=https://sopanen.net/tags/python/>Python</a></span>
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
1788 Words
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2020-08-29 07:28 +0000
</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h></span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://sopanen.net/posts/deploying-a-serverless-microservice-with-flask-zappa/>
<span class=button__icon>‚Üê</span>
<span class=button__text>Deploying a serverless microservice with Flask & Zappa</span>
</a>
</span>
</div>
</div>
<div id=comments>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//rafrasenberg-com.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
</main>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=footer__content>
<span>¬© 2020</span>
<a href=https://sopanen.net/><span>Raf Rasenberg</span></a>
</div>
</div>
</footer>
</div>
<script type=text/javascript src=https://sopanen.net/bundle.min.a0f363fdf81cdc5cfacc447a79c33189eb000d090336cd04aac8ee256f423b3133b836c281944c19c75e38d0b0b449f01ce5807e37798b7ac94ac1db51983fc4.js integrity="sha512-oPNj/fgc3Fz6zER6ecMxiesADQkDNs0EqsjuJW9COzEzuDbCgZRMGcdeONCwtEnwHOWAfjd5i3rJSsHbUZg/xA=="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-177931139-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-177931139-1')</script>
<script>(function(c,e,f,h,b,d){c.MailerLiteObject=b;function a(){var b={a:arguments,q:[]},c=this.push(b);return"number"!=typeof c?c:a.bind(b.q)}a.q=a.q||[],c[b]=c[b]||a.bind(a.q),c[b].q=c[b].q||a.q,d=e.createElement(f);var g=e.getElementsByTagName(f)[0];d.async=1,d.src=h+'?v'+~~((new Date).getTime()/1e6),g.parentNode.insertBefore(d,g)})(window,document,'script','https://static.mailerlite.com/js/universal.js','ml');var ml_account=ml('accounts','2387594','n2l1g5f0i1','load')</script>
</body>
</html>
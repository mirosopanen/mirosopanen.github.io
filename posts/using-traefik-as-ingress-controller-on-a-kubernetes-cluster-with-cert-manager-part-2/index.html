<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=author content="Miro Sopanen ">
<meta name=description content="Part 2 of the Kubernetes blog series. In this part we deploy the Traefik dashboard and an example application to our cluster, fully TLS encrypted.">
<meta name=keywords content=",kubernetes,terraform,server,cloud,dev-ops">
<meta name=robots content="noodp">
<meta name=theme-color content="#d58432">
<link rel=canonical href=https://vonsopanen.github.io/posts/using-traefik-as-ingress-controller-on-a-kubernetes-cluster-with-cert-manager-part-2/>
<title>
Using Traefik as Ingress Controller on a Kubernetes cluster with cert-manager | Part 2
</title>
<link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css>
<link rel=stylesheet href=https://vonsopanen.github.io/main.491d9de14a60a99da243398aa5873cb28a058c58cb30eb698c56e003d11d6aab.css>
<meta itemprop=name content="Using Traefik as Ingress Controller on a Kubernetes cluster with cert-manager | Part 2">
<meta itemprop=description content="Part 2 of the Kubernetes blog series. In this part we deploy the Traefik dashboard and an example application to our cluster, fully TLS encrypted."><meta itemprop=datePublished content="2020-11-22T06:27:18+01:00">
<meta itemprop=dateModified content="2020-11-22T06:27:18+01:00">
<meta itemprop=wordCount content="1980"><meta itemprop=image content="https://vonsopanen.github.io/images/blog/7/header-image.png">
<meta itemprop=keywords content="kubernetes,terraform,server,cloud,dev-ops,">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://vonsopanen.github.io/images/blog/7/header-image.png">
<meta name=twitter:title content="Using Traefik as Ingress Controller on a Kubernetes cluster with cert-manager | Part 2">
<meta name=twitter:description content="Part 2 of the Kubernetes blog series. In this part we deploy the Traefik dashboard and an example application to our cluster, fully TLS encrypted.">
<meta property="article:published_time" content="2020-11-22 06:27:18 +0100 +0100">
</head>
<body class=dark-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=https://vonsopanen.github.io/ style=text-decoration:none>
<div class=logo>
<span class=logo__mark>></span>
<span class=logo__text>$ cd /home/</span>
<span class=logo__cursor>
</span>
</div>
</a>
<span class=header__right>
<nav class=menu>
<ul class=menu__inner><li><a href=https://vonsopanen.github.io/about/>About</a></li><li><a href=https://vonsopanen.github.io/posts/>Posts</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<main class=post>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
10 minutes
</p>
</div>
<article>
<h1 class=post-title>
<a href=https://vonsopanen.github.io/posts/using-traefik-as-ingress-controller-on-a-kubernetes-cluster-with-cert-manager-part-2/>Using Traefik as Ingress Controller on a Kubernetes cluster with cert-manager | Part 2</a>
</h1>
<div class=post-content>
<h2 id=introduction->Introduction üìå</h2>
<p>This is Part 2 of the Kubernetes blog series. In this part, we will deploy and expose the Traefik dashboard to a custom domain. As a bonus, we will deploy a small example application as well.</p>
<p>The domains will be pointed to our external load balancer and we will secure them with Let&rsquo;s Encrypt through cert-manager.</p>
<p>To follow along with this part, please <a href=https://rafrasenberg.com/posts/kubernetes-with-terraform-traefik-v2-cert-manager-part-1/>follow Part 1 first</a>.</p>
<p>With that being said, let&rsquo;s deploy some services to our shiny new Kubernetes cluster! üëè</p>
<blockquote>
<p>Article experience level: <strong>Intermediate</strong></p>
</blockquote>
<p>I categorize every article based on complexity. It&rsquo;s a good way to indicate how well you can follow along with the article since it determines how deep I will explain certain concepts.</p>
<p><strong>Prerequisites</strong></p>
<ul>
<li>Followed <a href=https://rafrasenberg.com/posts/kubernetes-with-terraform-traefik-v2-cert-manager-part-1/>Part 1</a></li>
<li>Domain name</li>
<li>kubectl installed</li>
<li>doctl installed</li>
</ul>
<p>üëâ <a href=https://github.com/rafrasenberg/kubernetes-terraform-traefik-cert-manager>The Github repo for this blog post</a></p>
<h2 id=interacting-with-our-kubernetes-cluster>Interacting with our Kubernetes cluster</h2>
<p>In order to interact with our cluster from our local machine, we need <code>kubectl</code> installed.</p>
<p>The Kubernetes command-line tool, <code>kubectl</code>, allows you to run commands against Kubernetes clusters. You can use <code>kubectl</code> to deploy applications, inspect and manage cluster resources, and view logs.</p>
<p>Besides the Kubernetes command-line tool, we also need <code>doctl</code>. This is the official DigitalOcean command-line client. It uses the DigitalOcean API to provide access to most account and Droplet features.</p>
<p>Please follow the docs to install both of these on your machine:</p>
<ul>
<li><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/>Install kubectl</a></li>
<li><a href=https://www.digitalocean.com/docs/apis-clis/doctl/how-to/install/>Install doctl</a></li>
</ul>
<p>From this moment on I am assuming that you have successfully installed and configured <code>kubectl</code> and <code>doctl</code>.</p>
<p>When those are installed please visit the Digital Ocean dashboard and go to your cluster. There you will find a command to connect to your cluster, for easy multiple-cluster management.</p>
<p><img src=https://vonsopanen.github.io/images/blog/7/kubernetes-connect-kubectl.png alt="Kubernetes Cluster Digital Ocean Kubectl"></p>
<p>Paste this command in your terminal and connect your cluster.</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ doctl kubernetes cluster kubeconfig save 33d303ec-4b1e-4972-8e9e-670344a64122
</code></pre><p><strong>Output:</strong></p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>Notice: Adding cluster credentials to kubeconfig file found in &quot;/home/raf/.kube/config&quot;
Notice: Setting current-context to do-ams3-my-special-cluster
</code></pre><p>Great. Everything is set-up now.</p>
<h2 id=testing-our-cluster-and-configuration->Testing our cluster and configuration üëÄ</h2>
<p>Alright with our Kubernetes cluster successfully connected, let&rsquo;s run some commands to verify if our cluster install went as we expected.</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ kubectl get nodes
</code></pre><p><strong>Output:</strong></p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>NAME                            STATUS   ROLES    AGE     VERSION
my-special-cluster-pool-3hkcb   Ready    &lt;none&gt;   3h28m   v1.19.3
my-special-cluster-pool-3hkcw   Ready    &lt;none&gt;   3h29m   v1.19.3
</code></pre><p>As you can see, we can interact with our cluster right now through <code>kubectl</code>, so that means we can deploy some services!</p>
<p>In the previous blog post and what you can see back in your Terraform configuration, is that we deployed two services through Helm:</p>
<ul>
<li>Traefik</li>
<li>cert-manager</li>
</ul>
<p>So let&rsquo;s see if they are up and running in our cluster without any errors. Let&rsquo;s check Traefik first.</p>
<p>We use the <code>get svc</code> (shorthand for <code>get services</code>) command to list all services in the default namespace. As you might remember from our Terraform configuration, we created a <code>traefik</code> namespace and deployed the Traefik Helm repository into that. So therefore we will specify the <code>-n</code> namespace flag, to return all services in that namespace.</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ kubectl get svc -n traefik
</code></pre><p><strong>Output:</strong></p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>NAME      TYPE           CLUSTER-IP       EXTERNAL-IP    PORT(S)                      AGE
traefik   LoadBalancer   10.245.173.208   64.225.81.60   80:31782/TCP,443:31660/TCP   3h31m
</code></pre><p>Awesome! Our Traefik LoadBalancer is successfully running as you can see.</p>
<p>The above output lists the Cluster-IP, the External-IP as well as the target and node-ports the service is running on.</p>
<p>The external IP is the one that is exposed to the outside with the Digital Ocean load balancer behind it. So that will be the IP address where you will be pointing your domain name to.</p>
<p>Now let&rsquo;s quickly go over this again but then for <code>cert-manager</code>.</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ kubectl get svc -n cert-manager
</code></pre><p><strong>Output:</strong></p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
cert-manager           ClusterIP   10.245.118.110   &lt;none&gt;        9402/TCP   3h44m
cert-manager-webhook   ClusterIP   10.245.145.85    &lt;none&gt;        443/TCP    3h44m
</code></pre><p>As you can see, all is up and running! üöÄ</p>
<h2 id=deploying-the-clusterissuer>Deploying the ClusterIssuer</h2>
<p>The first thing we need to do first is deploying the ClusterIssuer that will generate free SSL certificates for us.</p>
<h4 id=what-is-a-clusterissuer>What is a ClusterIssuer?</h4>
<p>Issuers, and ClusterIssuers, are Kubernetes resources that represent certificate authorities (CAs) that are able to generate signed certificates by honoring certificate signing requests. All <code>cert-manager</code> certificates require a referenced issuer that is in a ready condition to attempt to honor the request.</p>
<p>If you want to create a single Issuer that can be consumed in multiple namespaces, you should consider creating a ClusterIssuer resource. This is almost identical to the Issuer resource, however is non-namespaced so it can be used to issue Certificates across all namespaces.</p>
<p>For this, we will be using ClusterIssuer.</p>
<p>Let&rsquo;s create the <code>post-deployment</code> folder and in there a <code>01-cert-manager</code> folder with a <code>01-issuer.yml</code> file:</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ mkdir post-deployment/01-cert-manager &amp;&amp; touch post-deployment/01-cert-manager/01-issuer.yml
</code></pre><p>Within the <code>01-issuer.yml</code> file, add this configuration:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>cert-manager.io/v1alpha2</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterIssuer</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>letsencrypt-prod</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>acme</span>:
    <span style=color:#f92672>email</span>: <span style=color:#ae81ff>youremail@gmail.com</span>
    <span style=color:#f92672>server</span>: <span style=color:#ae81ff>https://acme-v02.api.letsencrypt.org/directory</span>
    <span style=color:#f92672>solvers</span>:
      - <span style=color:#f92672>http01</span>:
          <span style=color:#f92672>ingress</span>:
            <span style=color:#f92672>class</span>: <span style=color:#ae81ff>traefik-cert-manager</span>
</code></pre></div><p>Please make sure you modify the email, this has to be a valid one.</p>
<p>As you can see from the configuration, we are using a <code>http01</code> solver here. <code>cert-manager</code> offers two methods of validation:</p>
<ul>
<li>DNS Validation</li>
<li>HTTP Validation</li>
</ul>
<p>When working with different kinds of domains, a HTTP01 validation is the easiest. With a HTTP01 challenge, you prove ownership of a domain by ensuring that a particular file is present at the domain. It is assumed that you control the domain if you are able to publish the given file under a given path.</p>
<p>DNS validation on the other hand is very useful when you are working with an organization&rsquo;s domain name and you would like to deploy services on subdomains like so: <code>*.yourdomain.com</code>. You can then generate a wildcard certificate and solve the DNS challenge through services like Cloudflare or AWS Route53.</p>
<p>As you might notice here, you see that the <code>http01</code> ingress class is called <code>traefik-cert-manager</code>. Where did we see that before?</p>
<p>Ah yes! In the custom values file within our Terraform configuration for the Traefik Helm deployment.</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>additionalArguments:
  - &quot;--providers.kubernetesIngress.ingressClass=traefik-cert-manager&quot;
</code></pre><p>Now you know what that is for! üòÑ</p>
<p>Finally, let&rsquo;s deploy our ClusterIssuer through <code>kubectl</code>:</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ kubectl apply -f post-deployment/01-cert-manager/01-issuer.yml
</code></pre><p>Now with our ClusterIssuer successfully in place, we can start generating certificates for our services.</p>
<h2 id=exposing-the-traefik-dashboard>Exposing the Traefik dashboard</h2>
<p>To access the Traefik dashboard, you will need a domain name pointing to the load balancer&rsquo;s external IP. You can check which IP that is with the <code>kubectl get svc -n traefik</code> command that we explained earlier.</p>
<p>Then in your registrar panel just add an <code>A</code> record pointing to that IP address.</p>
<p>With that done let&rsquo;s create a folder that will hold our certificates and in there the certificate file for the Traefik dashboard:</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ mkdir post-deployment/certificates &amp;&amp; touch post-deployment/certificates/traefik-dashboard.yml
</code></pre><p>Now edit the <code>traefik-dashboard.yml</code> file and add this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>cert-manager.io/v1alpha2</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Certificate</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>traefik-dashboard-cert</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>traefik</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>&#34;use-http01-solver&#34;: </span><span style=color:#e6db74>&#34;true&#34;</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>commonName</span>: <span style=color:#ae81ff>traefik.yourdomain.com</span>
  <span style=color:#f92672>secretName</span>: <span style=color:#ae81ff>traefik-dashboard-cert</span>
  <span style=color:#f92672>dnsNames</span>:
    - <span style=color:#ae81ff>traefik.yourdomain.com</span>
  <span style=color:#f92672>issuerRef</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>letsencrypt-prod</span>
    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterIssuer</span>
</code></pre></div><p>Please change the domain/sub-domain name here, to the one you want to use for the Traefik dashboard. If you have done that, run the following command to generate a certificate:</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ kubectl apply -f post-deployment/certificates/traefik-dashboard.yml
</code></pre><p>Now wait around a minute or 2 and then run the following command to check if your certificate is ready and you didn&rsquo;t run into any errors:</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ kubectl -n traefik describe certificate traefik-dashboard-cert
</code></pre><p><strong>Output:</strong></p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>...
Status:
  Conditions:
    Last Transition Time:  2020-11-22T10:03:19Z
    Message:               Certificate is up to date and has not expired
    Reason:                Ready
    Status:                True
    Type:                  Ready
  Not After:               2021-02-20T09:03:18Z
  Not Before:              2020-11-22T09:03:18Z
  Renewal Time:            2021-01-21T09:03:18Z
  Revision:                1
Events:
  Type    Reason     Age   From          Message
  ----    ------     ----  ----          -------
  Normal  Issuing    100s  cert-manager  Issuing certificate as Secret does not exist
  Normal  Generated  99s   cert-manager  Stored new private key in temporary Secret resource &quot;traefik-dashboard-cert-dcc7c&quot;
  Normal  Requested  99s   cert-manager  Created new CertificateRequest resource &quot;traefik-dashboard-cert-66zld&quot;
  Normal  Issuing    95s   cert-manager  The certificate has been successfully issued
</code></pre><p>Awesome, all done! Let&rsquo;s now create our Traefik deployment files and register the dashboard as an Ingress route so we can reach it through the specified domain name.</p>
<p>We will create a new folder within our <code>post-deployment</code> folder and add a <code>middleware.yml</code> and <code>ingress.yml</code> file:</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ mkdir post-deployment/02-traefik
$ touch post-deployment/02-traefik/01-middleware.yml post-deployment/02-traefik/02-ingress.yml
</code></pre><p>Because the Traefik dashboard is exposed by default, we will add a general Kubernetes secret and a Traefik middleware to create simple basic auth protection.</p>
<p>You can add your own password there of course, by using a tool like <code>htpassword</code>. Traefik supports passwords hashed with MD5, SHA1, or BCrypt.</p>
<p>In <code>middleware.yml</code> add the following:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Secret</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>traefik-dashboard-auth</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>traefik</span>
<span style=color:#f92672>data</span>:
  <span style=color:#75715e># Login: raf | 123</span>
  <span style=color:#f92672>users</span>: <span style=color:#ae81ff>cmFmOiRhcHIxJGRiN1VMZzFGJDB6OUFtWUVLaWRTQ0h4RkpxODdGYTEKCg==</span>
---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>traefik.containo.us/v1alpha1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Middleware</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>traefik-dashboard-basicauth</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>traefik</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>basicAuth</span>:
    <span style=color:#f92672>secret</span>: <span style=color:#ae81ff>traefik-dashboard-auth</span>
</code></pre></div><p>Now add the ingress route configuration in <code>02-ingress.yml</code>, of course changing your domain name again:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>traefik.containo.us/v1alpha1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>IngressRoute</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>traefik-dashboard</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>traefik</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>entryPoints</span>:
    - <span style=color:#ae81ff>websecure</span>
  <span style=color:#f92672>routes</span>:
    - <span style=color:#f92672>match</span>: <span style=color:#ae81ff>Host(`traefik.yourdomain.com`)</span>
      <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Rule</span>
      <span style=color:#f92672>middlewares</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>traefik-dashboard-basicauth</span>
          <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>traefik</span>
      <span style=color:#f92672>services</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>api@internal</span>
          <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>TraefikService</span>
          <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
  <span style=color:#f92672>tls</span>:
    <span style=color:#f92672>secretName</span>: <span style=color:#ae81ff>traefik-dashboard-cert</span>
</code></pre></div><h4 id=lets-deploy->Let&rsquo;s deploy üöÄ</h4>
<p>Alright with everything prepared now, let&rsquo;s deploy our Ingress route and expose the Traefik dashboard! By running the command below, <code>kubectl</code> will first apply the middleware and then deploy the ingress route.</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ kubectl apply -f post-deployment/02-traefik/
</code></pre><p>BOOM! We got it up and running. üéØ</p>
<p>If you follow the domain name you will be greeted with a TLS encrypted route to the Traefik dashboard. After entering the basic auth username and password, the dashboard will be displayed. Awesome!</p>
<p><img src=https://vonsopanen.github.io/images/blog/7/traefik-dashboard-1.png alt="Traefik Dashboard"></p>
<p>As you can see when you view the HTTP routers, you can see our dashboard route is safely secured with TLS and Traefik recognizes it as a Kubernetes route.</p>
<p><img src=https://vonsopanen.github.io/images/blog/7/traefik-dashboard-2.png alt="Traefik HTTP Routers"></p>
<h2 id=an-example-application>An example application</h2>
<p>With the dashboard up and running, let&rsquo;s deploy an example <code>whoami</code> application with TLS encryption. The first thing you have to do again, is to add a DNS entry for the <code>whoami</code> service. Then add the appropriate folder and files:</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ mkdir post-deployment/03-whoami
$ touch post-deployment/certificates/whoami.yml
$ touch post-deployment/03-whoami/01-whoami.yml post-deployment/03-whoami/02-ingress.yml
</code></pre><p>Time to create a new certificate. So add this to <code>post-deployment/certificates/whoami.yml</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>cert-manager.io/v1alpha2</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Certificate</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>whoami-cert</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>whoami</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>&#34;use-http01-solver&#34;: </span><span style=color:#e6db74>&#34;true&#34;</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>commonName</span>: <span style=color:#ae81ff>whoami.rafrasenberg.com</span>
  <span style=color:#f92672>secretName</span>: <span style=color:#ae81ff>whoami-cert</span>
  <span style=color:#f92672>dnsNames</span>:
    - <span style=color:#ae81ff>whoami.rafrasenberg.com</span>
  <span style=color:#f92672>issuerRef</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>letsencrypt-prod</span>
    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterIssuer</span>
</code></pre></div><p>Then add <code>01-whoami.yml</code> inside the <code>post-deployment/03-whoami</code> folder:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>whoami</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>whoami</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>matchLabels</span>:
      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>whoami</span>
  <span style=color:#f92672>template</span>:
    <span style=color:#f92672>metadata</span>:
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>whoami</span>
    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>containers</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>whoami</span>
          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>containous/whoami</span>
          <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>

---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>whoami</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>whoami</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>whoami</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>ClusterIP</span>
  <span style=color:#f92672>ports</span>:
    - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>whoami</span>
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>whoami</span>
</code></pre></div><p>Then add the ingress route in <code>02-ingress.yml</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>traefik.containo.us/v1alpha1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>IngressRoute</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>whoami</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>whoami</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>entryPoints</span>:
    - <span style=color:#ae81ff>websecure</span>
  <span style=color:#f92672>routes</span>:
    - <span style=color:#f92672>match</span>: <span style=color:#ae81ff>Host(`whoami.rafrasenberg.com`)</span>
      <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Rule</span>
      <span style=color:#f92672>services</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>whoami</span>
          <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
  <span style=color:#f92672>tls</span>:
    <span style=color:#f92672>secretName</span>: <span style=color:#ae81ff>whoami-cert</span>
</code></pre></div><p>Alright so before we are generating the certificate again, don&rsquo;t forget to create the <code>whoami</code> namespace, since we are deploying to that and it isn&rsquo;t there yet.</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ kubectl create namespace whoami
</code></pre><p>Then generate our certificate again:</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ kubectl apply -f post-deployment/certificates/whoami.yml
</code></pre><p>Wait for some time and see if it is successfully issued:</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ kubectl -n whoami describe certificate whoami-cert
</code></pre><p>If everything thing went well and your certificate was successfully issued, deploy the <code>whoami</code> service:</p>
<pre tabindex=0><code class=language-sh-session data-lang=sh-session>$ kubectl apply -f post-deployment/03-whoami/
</code></pre><p>Great work! üî• As you can see, the <code>whoami</code> service is available through the domain name, running over TLS:</p>
<p><img src=https://vonsopanen.github.io/images/blog/7/whoami-service.png alt="Whoami Service"></p>
<p>You can see the service in the Traefik dashboard now as well:</p>
<p><img src=https://vonsopanen.github.io/images/blog/7/traefik-dashboard-3.png alt="Whoami Service in Traefik dashboard"></p>
<h2 id=conclusion->Conclusion ‚ö°</h2>
<p>Alright so in this blog post we configured our cluster further.</p>
<p>We exposed the Traefik dashboard and deployed an example application. Of course, now it is time to build on this. The issuing of certificates and deployment of the ingress routes, for example, is something that can be automated as well.</p>
<p>However for now we will leave it to this, and hopefully, you learned enough from it so that you can build out your Kubernetes cluster yourself. In the future, I will definitely post some more about it.</p>
<p>See you next time! üëã</p>
<p><strong>Sources used for this post</strong>:</p>
<ul>
<li><a href=https://kubernetes.io/docs/home/>Kubernetes Docs</a></li>
<li><a href=https://cert-manager.io/docs/>cert-manager Docs</a></li>
</ul>
</div>
</article>
<hr>
<div class=post-info>
<p>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://vonsopanen.github.io/tags/kubernetes/>kubernetes</a></span><span class=tag><a href=https://vonsopanen.github.io/tags/terraform/>terraform</a></span><span class=tag><a href=https://vonsopanen.github.io/tags/server/>server</a></span><span class=tag><a href=https://vonsopanen.github.io/tags/cloud/>cloud</a></span><span class=tag><a href=https://vonsopanen.github.io/tags/dev-ops/>dev-ops</a></span>
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
1980 Words
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2020-11-22 05:27 +0000
</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h></span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://vonsopanen.github.io/posts/deploying-fastapi-on-aws-as-a-lambda-container-image/>
<span class=button__icon>‚Üê</span>
<span class=button__text>Deploying FastAPI on AWS as a lambda container image</span>
</a>
</span>
<span class="button next">
<a href=https://vonsopanen.github.io/posts/kubernetes-with-terraform-traefik-v2-cert-manager-part-1/>
<span class=button__text>Kubernetes with Terraform & Traefik V2 + cert-manager | Part 1</span>
<span class=button__icon>‚Üí</span>
</a>
</span>
</div>
</div>
<div id=comments>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//rafrasenberg-com.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
</main>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=footer__content>
<span>¬© 2020</span>
<a href=https://vonsopanen.github.io/><span>Raf Rasenberg</span></a>
</div>
</div>
</footer>
</div>
<script type=text/javascript src=https://vonsopanen.github.io/bundle.min.a0f363fdf81cdc5cfacc447a79c33189eb000d090336cd04aac8ee256f423b3133b836c281944c19c75e38d0b0b449f01ce5807e37798b7ac94ac1db51983fc4.js integrity="sha512-oPNj/fgc3Fz6zER6ecMxiesADQkDNs0EqsjuJW9COzEzuDbCgZRMGcdeONCwtEnwHOWAfjd5i3rJSsHbUZg/xA=="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-177931139-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-177931139-1')</script>
<script>(function(c,e,f,h,b,d){c.MailerLiteObject=b;function a(){var b={a:arguments,q:[]},c=this.push(b);return"number"!=typeof c?c:a.bind(b.q)}a.q=a.q||[],c[b]=c[b]||a.bind(a.q),c[b].q=c[b].q||a.q,d=e.createElement(f);var g=e.getElementsByTagName(f)[0];d.async=1,d.src=h+'?v'+~~((new Date).getTime()/1e6),g.parentNode.insertBefore(d,g)})(window,document,'script','https://static.mailerlite.com/js/universal.js','ml');var ml_account=ml('accounts','2387594','n2l1g5f0i1','load')</script>
</body>
</html>